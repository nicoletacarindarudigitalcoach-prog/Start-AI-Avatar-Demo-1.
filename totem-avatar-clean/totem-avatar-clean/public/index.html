<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>Totem Avatar Streaming - HeyGen + ChatGPT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
  </head>

  <body class="bg-neutral-900 text-neutral-100 p-6">
    <h1 class="text-2xl font-bold mb-4">Totem Avatar: voce â†’ ChatGPT â†’ HeyGen</h1>

    <!-- UI -->
    <div class="flex gap-4">
      <div>
        <button id="startBtn" class="px-4 py-2 bg-green-600 rounded">Start</button>
        <button id="stopBtn" class="px-4 py-2 bg-red-600 rounded">Stop</button>
      </div>
    </div>

    <video id="videoOutput" class="w-[360px] h-[640px] bg-black mt-6" autoplay></video>

    <div class="mt-3">
      <input id="inputText" class="w-80 p-2 text-black" placeholder="Scrivi testo" />
      <button id="talkBtn" class="px-4 py-2 bg-blue-500 rounded">Talk (LLM HEYGEN)</button>
      <button id="repeatBtn" class="px-4 py-2 bg-purple-500 rounded">Repeat</button>
    </div>

    <div class="mt-4">
      <button id="micBtn" class="px-4 py-2 bg-yellow-400 text-black font-bold rounded">
        ðŸŽ¤ Parla (usando il microfono)
      </button>
    </div>

    <pre id="log" class="mt-4 text-sm bg-neutral-800 p-4 rounded h-48 overflow-auto"></pre>

    <script>
      const logEl = document.getElementById("log");
      const videoEl = document.getElementById("videoOutput");

      let session = null;
      let token = null;
      let room = null;
      let mediaStream = null;

      const showLog = (msg) => {
        logEl.innerHTML += msg + "\n";
        logEl.scrollTop = logEl.scrollHeight;
      };

      async function getToken() {
        const r = await fetch("/api/token", { method: "POST" });
        const j = await r.json();
        return j.token;
      }

      document.getElementById("startBtn").addEventListener("click", async () => {
        showLog("Creo sessioneâ€¦");

        token = await getToken();

        const env = await fetch("/env.json").then((r) => r.json());

        const r = await fetch("https://api.heygen.com/v1/streaming.new", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            version: "v2",
            avatar_name: env.DEFAULT_AVATAR_NAME,
            quality: "high",
          }),
        });

        session = (await r.json()).data;
        showLog("Sessione creata: " + session.session_id);

        await fetch("https://api.heygen.com/v1/streaming.start", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ session_id: session.session_id }),
        });

        room = new LivekitClient.Room();
        mediaStream = new MediaStream();

        room.on(LivekitClient.RoomEvent.TrackSubscribed, (track) => {
          mediaStream.addTrack(track.mediaStreamTrack);
          videoEl.srcObject = mediaStream;
        });

        await room.connect(session.url, session.access_token);
        showLog("âœ… Streaming pronto");
      });

      async function sendTextToAvatar(text, mode = "talk") {
        await fetch("https://api.heygen.com/v1/streaming.task", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            session_id: session.session_id,
            text,
            task_type: mode,
          }),
        });

        showLog("[â†’ ALL'AVATAR] " + text);
      }

      // bottoni talk/repeat
      document.getElementById("talkBtn").onclick = () => {
        const txt = document.getElementById("inputText").value;
        sendTextToAvatar(txt, "talk");
      };
      document.getElementById("repeatBtn").onclick = () => {
        const txt = document.getElementById("inputText").value;
        sendTextToAvatar(txt, "repeat");
      };

      // MICROFONO â†’ CHATGPT â†’ AVATAR
      document.getElementById("micBtn").onclick = async () => {
        showLog("ðŸŽ¤ ascoltoâ€¦");
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const recorder = new MediaRecorder(stream);
        let chunks = [];
        recorder.ondataavailable = (e) => chunks.push(e.data);
        recorder.onstop = async () => {
          const blob = new Blob(chunks, { type: "audio/webm" });
          const formData = new FormData();
          formData.append("audio", blob);

          const resp = await fetch("/api/chat", {
            method: "POST",
            body: JSON.stringify({ prompt: "trascrivi audio e rispondi" }),
            headers: { "Content-Type": "application/json" },
          });

          const j = await resp.json();
          sendTextToAvatar(j.text, "talk");
        };

        recorder.start();
        setTimeout(() => recorder.stop(), 3000);
      };
    </script>
  </body>
</html>
