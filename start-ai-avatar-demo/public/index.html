<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Totem Avatar: voce â†’ ChatGPT â†’ HeyGen</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- LiveKit Client SDK -->
  <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>

</head>

<body class="bg-black text-white p-5 font-sans">
  <h1 class="text-2xl mb-2">Totem Avatar: voce â†’ ChatGPT â†’ HeyGen</h1>

  <div class="flex gap-4 mb-4">
    <button id="startBtn" class="px-4 py-2 bg-green-600 rounded">Start</button>
    <button id="stopBtn" class="px-4 py-2 bg-red-600 rounded">Stop</button>
  </div>

  <div class="flex">
    <!-- VIDEO -->
    <video id="media" autoplay playsinline class="w-[360px] h-[640px] bg-black rounded"></video>

    <!-- UI -->
    <div class="flex flex-col flex-1 ml-6">

      <form id="textForm" class="flex gap-2 mb-3">
        <input id="textInput" placeholder="Scrivi testo..." class="flex-1 text-black rounded px-3" />
        <button type="submit" class="px-4 bg-blue-600 rounded">Talk (LLM HEYGEN)</button>
        <button type="button" id="repeatBtn" class="px-4 bg-purple-600 rounded">Repeat</button>
      </form>

      <button id="micBtn" class="px-4 py-2 bg-yellow-500 text-black rounded mb-3">
        ðŸŽ¤ Parla (microfono)
      </button>

      <!-- LOG -->
      <pre id="log" class="bg-gray-800 p-3 h-[380px] overflow-y-auto text-xs rounded"></pre>
    </div>
  </div>

  <script>
    // DOM
    const logBox = document.getElementById("log");
    const media = document.getElementById("media");
    const micBtn = document.getElementById("micBtn");
    const textForm = document.getElementById("textForm");
    const textInput = document.getElementById("textInput");

    let room = null;
    let mediaStream = null;
    let sessionInfo = null;
    let sessionToken = null;
    let ws = null;
    let listening = false;

    function log(t) {
      logBox.textContent += t + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    }

    async function getEnv() {
      const r = await fetch("/api/env");  // âœ… MODIFICATO QUI
      return r.json();
    }

    async function createToken() {
      const r = await fetch("/api/token", { method: "POST" });
      const data = await r.json();
      sessionToken = data.token;
      log("Token OK");
    }

    async function newSession(defaultAvatar) {
      const r = await fetch("https://api.heygen.com/v1/streaming.new", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${sessionToken}`
        },
        body: JSON.stringify({
          version: "v2",
          avatar_name: defaultAvatar,
        })
      });

      const data = await r.json();
      sessionInfo = data.data;
      log("Sessione creata: " + sessionInfo.session_id);
    }

    async function startStreaming() {
      await fetch("https://api.heygen.com/v1/streaming.start", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${sessionToken}`
        },
        body: JSON.stringify({ session_id: sessionInfo.session_id })
      });

      log("HeyGen: streaming avviato");

      room = new LivekitClient.Room();
      mediaStream = new MediaStream();

      room.on(LivekitClient.RoomEvent.TrackSubscribed, (track) => {
        mediaStream.addTrack(track.mediaStreamTrack);
        media.srcObject = mediaStream;
      });

      await room.connect(sessionInfo.url, sessionInfo.access_token);
      log("âœ… LiveKit connesso â€” streaming pronto");
    }

    async function sendToChatGPT(text) {
      log(`âž¡ï¸ Utente: ${text}`);

      const r = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });

      const data = await r.json();
      log(`ðŸ¤– ChatGPT: ${data.reply}`);

      return data.reply;
    }

    async function heygenSpeak(text, mode = "talk") {
      await fetch("https://api.heygen.com/v1/streaming.task", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${sessionToken}`
        },
        body: JSON.stringify({
          session_id: sessionInfo.session_id,
          text,
          task_type: mode
        })
      });
    }

    document.getElementById("startBtn").onclick = async () => {
      log("Avvio...");

      const env = await getEnv();
      await createToken();
      await newSession(env.DEFAULT_AVATAR_NAME);
      await startStreaming();
    };

    document.getElementById("stopBtn").onclick = () => location.reload();

    textForm.onsubmit = async (e) => {
      e.preventDefault();
      const text = textInput.value;
      textInput.value = "";
      await heygenSpeak(text, "talk");
    };

    document.getElementById("repeatBtn").onclick = () => {
      heygenSpeak(textInput.value, "repeat");
      textInput.value = "";
    };

    // ---- MICROFONO â†’ GPT â†’ HEYGEN ----
    micBtn.onclick = async () => {
      if (listening) return;

      listening = true;
      micBtn.textContent = "ðŸŽ¤ Sto ascoltando...";

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const rec = new MediaRecorder(stream);
      const chunks = [];

      rec.ondataavailable = (e) => chunks.push(e.data);

      rec.onstop = async () => {
        const blob = new Blob(chunks, { type: "audio/webm" });
        const text = await blob.text(); // semplificazione
        const reply = await sendToChatGPT(text);
        await heygenSpeak(reply, "talk");

        listening = false;
        micBtn.textContent = "ðŸŽ¤ Parla (microfono)";
      };

      rec.start();
      setTimeout(() => rec.stop(), 3500);
    };
  </script>

</body>

</html>
